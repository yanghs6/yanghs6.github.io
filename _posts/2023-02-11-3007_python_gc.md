---
date: 2023-02-12 22:18:00 +/-0900
title: "[Python] Python Garbage Collector"
categories: [Develop, python]
tags: [ê°œë°œ(develop), íŒŒì´ì¬(python), ê°€ë¹„ì§€ì»¬ë ‰í„°(garbage_collector), ë©”ëª¨ë¦¬(memory), í• ë‹¹(allocation)]

---
## ê°œìš”

ì•ˆë…•í•˜ì„¸ìš”.

ì´ë²ˆ ê¸€ì—ì„œëŠ” Pythonì˜ Garbage Collectorì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

í˜„ì¬ ê¸€ì€ CPython(Cython)ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©° Pypy, Jython ë“±ì€ ë‹¤ë¥¸ ë™ì‘ì„ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
## Garbage Collector(GC)ì˜ ê°œë…

### íŒŒì´ì¬ì—ì„œì˜ ë©”ëª¨ë¦¬ í• ë‹¹ê³¼ í•´ì œ

[íŒŒì´ì¬ ë©”ëª¨ë¦¬ ì •ë¦¬ ê¸€]({% post_url 2023-02-04-3006_python_memory %})ì—ì„œ ì‚´í´ë³¼ ìˆ˜ ìˆì§€ë§Œ íŒŒì´ì¬ì˜ ëª¨ë“  ê°ì²´ëŠ” í™ì— ë™ì ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤.

ë˜í•œ ê°ì²´ì˜ ì‚¬ìš©ì´ ëë‚˜ë©´ ë©”ëª¨ë¦¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ íŒŒì´ì¬ì—ì„œëŠ” ê°ì²´ì˜ ì‚¬ìš©ì´ ëë‚¬ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì–´ë–»ê²Œ í™•ì¸í• ê¹Œìš”?

### Garbage Collector

Garbage Collector(ì´í•˜ GC)ëŠ” í”„ë¡œê·¸ë¨ì´ ë™ì ìœ¼ë¡œ í• ë‹¹í–ˆë˜ ë©”ëª¨ë¦¬ ì˜ì—­ ì¤‘ í•„ìš”ì—†ê²Œ ëœ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

GCëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë²„ê·¸ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ìœ íš¨í•˜ì§€ ì•Šì€ í¬ì¸í„° ì ‘ê·¼: ì´ë¯¸ í•´ì œëœ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ëŠ” ë²„ê·¸ì…ë‹ˆë‹¤. ë§Œì•½ ì´ í¬ì¸í„°ê°€ í•´ì œë˜ê³  ìƒˆë¡œìš´ ê°’ì´ í• ë‹¹ë˜ì—ˆë‹¤ë©´, ì˜ëª»ëœ ê°’ì„ ì½ì–´ì˜¤ê²Œ ë©ë‹ˆë‹¤.
- ì´ì¤‘ í•´ì œ: ì´ë¯¸ í•´ì œëœ ë©”ëª¨ë¦¬ë¥¼ ë˜ë‹¤ì‹œ í•´ì œí•˜ëŠ” ë²„ê·¸ì…ë‹ˆë‹¤. ì¼ë¶€ ë©”ëª¨ë¦¬ í• ë‹¹ ì•Œê³ ë¦¬ì¦˜ì—ì„œëŠ”, í•´ì œëœ ë©”ëª¨ë¦¬ë¥¼ ë‹¤ì‹œ í•´ì œí•˜ë ¤ê³  ì‹œë„í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜: ë”ì´ìƒ í•„ìš”í•˜ì§€ ì•Šì€ ë©”ëª¨ë¦¬ê°€ í•´ì œë˜ì§€ ì•Šê³  ë‚¨ì•„ìˆëŠ” ë²„ê·¸ì…ë‹ˆë‹¤. ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°˜ë³µë˜ë©´ ë©”ëª¨ë¦¬ ê³ ê°ˆë¡œ í”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì ‘ê·¼ ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ê°€ ì¦ê°€í•˜ì—¬ ë©”ëª¨ë¦¬ê°€ ê³ ê°ˆë˜ëŠ” ë¬¸ì œëŠ” GCë¡œ ë§‰ì„ ìˆ˜ ì—†ë‹¤ê³  í•©ë‹ˆë‹¤.)

í•˜ì§€ë§Œ ë§ˆëƒ¥ ì¥ì ë§Œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë° GCì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

- ì–´ë–¤ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí• ì§€ ê²°ì •í•˜ëŠ” ë° ë¦¬ì†ŒìŠ¤ê°€ ì†Œìš”ë©ë‹ˆë‹¤. ê°ì²´ê°€ í•„ìš”ì—†ì–´ì§€ëŠ” ì‹œì ì„ í”„ë¡œê·¸ë˜ë¨¸ê°€ ë¯¸ë¦¬ ì•Œê³  ìˆëŠ” ê²½ìš°ì—ë„ GCê°€ ë©”ëª¨ë¦¬ í•´ì œ ì‹œì ì„ ì¶”ì í•´ì•¼ í•˜ë¯€ë¡œ, ì´ ì‘ì—…ì€ ì˜¤ë²„í—¤ë“œê°€ ë©ë‹ˆë‹¤.
- ì“°ë ˆê¸° ìˆ˜ì§‘ì´ ì¼ì–´ë‚˜ëŠ” íƒ€ì´ë°ì´ë‚˜ ì ìœ  ì‹œê°„ì„ ë¯¸ë¦¬ ì˜ˆì¸¡í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í”„ë¡œê·¸ë¨ì´ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ê²Œ ì¼ì‹œì ìœ¼ë¡œ ì •ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ ì‹œìŠ¤í…œì—ì„œëŠ” GCì˜ ì ìš©ì„ ê³ ë ¤í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- í• ë‹¹ëœ ë©”ëª¨ë¦¬ê°€ í•´ì œë˜ëŠ” ì‹œì ì„ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 

---

## íŒŒì´ì¬ GCì˜ ë™ì‘ì›ë¦¬

íŒŒì´ì¬ì—ì„œë„ GCë¥¼ ì´ìš©í•´ ë™ì  ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

GCëŠ” Reference Countì™€ Cyclic Referenceë¼ëŠ” 2ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ëŒ€ìƒì„ ì„ ë³„í•˜ê³  í• ë‹¹ í•´ì œí•©ë‹ˆë‹¤.

### â‘  Reference Count

ì²« ë²ˆì§¸ëŠ” ì°¸ì¡° íšŸìˆ˜ì…ë‹ˆë‹¤.

íŒŒì´ì¬ì˜ ëª¨ë“  ê°ì²´ëŠ” ì°¸ì¡° íšŸìˆ˜ë¥¼ ì§€ë‹™ë‹ˆë‹¤.

ì–´ë–¤ ê°ì²´ì˜ ì°¸ì¡° íšŸìˆ˜ê°€ 0ì´ ë˜ì—ˆì„ ë•Œ í•´ë‹¹ ê°ì²´ëŠ” ë©”ëª¨ë¦¬ì—ì„œ í• ë‹¹ í•´ì œë©ë‹ˆë‹¤.

ë‹¤ìŒ ì˜ˆì œ ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```python
import sys
import gc


a = "123"
b = [1, 2, 3]

print("==========")
print(sys.getrefcount(a))  # 4
print(gc.get_referrers(a))
print("==========")
print(sys.getrefcount(b))  # 2
print(gc.get_referrers(b))
```

`sys.getrefcount` í•¨ìˆ˜ëŠ” ê°ì²´ì˜ ì°¸ì¡° íšŸìˆ˜ë¥¼ ë°˜í™˜í•˜ë©°, ë‚´ë¶€ì ìœ¼ë¡œ ê°ì²´ë¥¼ ë³µì‚¬í•˜ë¯€ë¡œ (ì‹¤ì œ ì°¸ì¡° íšŸìˆ˜) + 1ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

`gc.get_referrers` í•¨ìˆ˜ëŠ” ê°ì²´ë¥¼ ì°¸ì¡°í•˜ëŠ” ê°ì²´ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ ìœ„ì˜ ì½”ë“œì—ì„œ ë³€ìˆ˜ `a`ëŠ” 3ë²ˆ, ë³€ìˆ˜ `b`ëŠ” 1ë²ˆ ì°¸ì¡°ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì—¬ê¸°ì„œ ë³€ìˆ˜ `a`ì˜ ì°¸ì¡° íšŸìˆ˜ì™€ ê´€ë ¨í•˜ì—¬ ëª‡ ê°€ì§€ ì˜ê²¬ì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆì—ˆì§€ë§Œ ëª…í™•í•œ ë‹µì„ ë‚´ë¦¬ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.

ê´€ë ¨í•˜ì—¬ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” ë§í¬ì™€ ì˜ê²¬ì„ ë‚¨ê¹ë‹ˆë‹¤.

1. ì°¸ì¡°íšŸìˆ˜ê°€ 4ë¡œ ì‹œì‘í•˜ëŠ” ì´ìœ : [https://stackoverflow.com/questions/45021901/why-does-a-newly-created-variable-in-python-have-a-ref-count-of-four](https://stackoverflow.com/questions/45021901/why-does-a-newly-created-variable-in-python-have-a-ref-count-of-four)
2. ì§€ì—­ë³€ìˆ˜: locals() í•¨ìˆ˜ í†µí•´ í™•ì¸ ê°€ëŠ¥
3. getefcount í•¨ìˆ˜: ê³µì‹ ë¬¸ì„œì˜ [https://docs.python.org/3.11/library/sys.html#sys.getrefcount](https://docs.python.org/3.11/library/sys.html#sys.getrefcount)
4. peephole optimazor: co_consts í‚¤ì›Œë“œ, /Python/peephole.c -> /Python/compile.cë¡œ ì´ë™í•œ optimazor ì½”ë“œ ([https://github.com/python/cpython/pull/21517/commits](https://github.com/python/cpython/pull/21517/commits))
5. ì»´íŒŒì¼ ê³¼ì •: ì»´íŒŒì¼ ê³¼ì •ì—ì„œ ì „ì²´ ì½”ë“œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì €ì¥

### â‘¡ Cyclic Reference

ë‘ ë²ˆì§¸ëŠ” ìˆœí™˜ì°¸ì¡°ì…ë‹ˆë‹¤.

ìˆœí™˜ì°¸ì¡°ê°€ ë°œìƒí•œ ê°ì²´ë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ ê°ì²´ë¥¼ ë©”ëª¨ë¦¬ì—ì„œ í• ë‹¹ í•´ì œí•©ë‹ˆë‹¤.

```python
import gc

class Link:
   def __init__(self, next_link=None):
       self.next_link = next_link

link_3 = Link()
link_2 = Link(link_3)
link_1 = Link(link_2)
link_3.next_link = link_1
A = link_1
del link_1, link_2, link_3

link_4 = Link()
link_4.next_link = link_4
del link_4

# Collect the unreachable Link object (and its .__dict__ dict).
gc.collect()
```

ìœ„ ì½”ë“œì˜ ê²½ìš°, `[link_1, link_2, link_3]`ì™€ `link_4`ì—ì„œ ê°ê° ìˆœí™˜ì°¸ì¡°ê°€ ë°œìƒí•©ë‹ˆë‹¤.

GCëŠ” ë‹¤ìŒì˜ ê³¼ì •ì„ í†µí•´ ìˆœí™˜ì°¸ì¡°ë¥¼ í™•ì¸í•˜ê³  ë©”ëª¨ë¦¬ í• ë‹¹ í•´ì œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

#### â“ª ì‹œì‘ ì „ ì•Œì•„ë‘˜ ì‚¬ì‹¤

ë¨¼ì € gc_ref ê°’ìœ¼ë¡œ GC ì•Œê³ ë¦¬ì¦˜ ì‹œì‘ ë‹¨ê³„ì—ì„œ ì°¸ì¡° íšŸìˆ˜ë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜ì™€ ë™ì¼í•œ ê°’ì˜ ë³€ìˆ˜(ë‹¤ìŒ ê·¸ë¦¼ì—ì„œëŠ” gc_ref)ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

ë‘ë²ˆì§¸ëŠ” ê°ì²´ì˜ ìƒíƒœ ë³€ê²½ìœ¼ë¡œ GCëŠ” ë„ë‹¬í•  ìˆ˜ ì—†ëŠ”(ë‹¤ìŒ ê·¸ë¦¼ì—ì„œëŠ” unreach) ê°ì²´ë§Œ ë³€ê²½í•©ë‹ˆë‹¤.

ì´ëŠ” "ëŒ€ë¶€ë¶„ì˜ ê°ì²´ëŠ” ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤"ëŠ” ê°€ì • í•˜ì—ì„œ ìœ ìš©í•œ ì ‘ê·¼ ë°©ì‹ì…ë‹ˆë‹¤.

#### â‘  GC ìˆ˜í–‰ ì „

![ìˆœí™˜ì°¸ì¡° 01 GC ìˆ˜í–‰ ì „](/assets/img/develop/3007/3007_01_cyclic_reference_01.png)
_[ê·¸ë¦¼01] ìˆœí™˜ì°¸ì¡° 01 GC ìˆ˜í–‰ ì „_

GC ìˆ˜í–‰ ì´ì „ ê°ì²´ë³„ ì°¸ì¡° ìƒíƒœì…ë‹ˆë‹¤.

ì‹¤ì œ ì°¸ì¡° íšŸìˆ˜ì™€ ë™ì¼í•œ ê°’ì„ ê°€ì§€ëŠ” gc_ref ê°’ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### â‘¡ gc_ref ê°’ ê°ì†Œ

![ìˆœí™˜ì°¸ì¡° 02](/assets/img/develop/3007/3007_02_cyclic_reference_02.png)
_[ê·¸ë¦¼02] ìˆœí™˜ì°¸ì¡° 02 gc\_ref ê°’ ê°ì†Œ_

GCë¥¼ ìˆ˜í–‰í•˜ë©´ ëª¨ë“  ê°ì²´ì˜ gc_refë¥¼ 1ì”© ê°ì†Œì‹œí‚µë‹ˆë‹¤.

ì—¬ê¸°ì„œ Object to Scan ëª©ë¡ì˜ ì™¸ë¶€ì— ì°¸ì¡°ê°€ ìˆëŠ” ê°ì²´ë§Œ gc_ref > 0ì— í•´ë‹µí•©ë‹ˆë‹¤.

gc_refê°€ 0ì¸ ê°ì²´ëŠ” ì°¸ì¡°í•  ìˆ˜ ì—†ëŠ” ìƒíƒœ, ì¦‰ UNREACH ìƒíƒœê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ê·¸ë¦¼ì—ì„œëŠ” `link_2`, `link_3`, `link_4` ê°ì²´ê°€ í•´ë‹¹ë©ë‹ˆë‹¤.

#### â‘¢ UNREACH ìƒíƒœë¡œ ë³€ê²½

![ìˆœí™˜ì°¸ì¡° 03](/assets/img/develop/3007/3007_03_cyclic_reference_03.png)
_[ê·¸ë¦¼03] ìˆœí™˜ì°¸ì¡° 03 unreach ìƒíƒœë¡œ ë³€ê²½_

ì—¬ê¸°ì„œ `link_3`, `link_4` ê°ì²´ë§Œ UNREACH ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.

`link_2` ê°ì²´ì˜ ê²½ìš° gc_ref ê°’ì´ 0ì´ì§€ë§Œ `link_1` ê°ì²´ì— ì˜í•´ ì™¸ë¶€ì—ì„œ ì°¸ì¡°ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

#### â‘£ REACHABLE ìƒíƒœ ê°ì²´ì—ì„œ ì ‘ê·¼ ë° ì¡°ê±´ì— ë§ëŠ” ê°ì²´ì˜ ìƒíƒœ ë³€ê²½

![ìˆœí™˜ì°¸ì¡° 04](/assets/img/develop/3007/3007_04_cyclic_reference_04.png)
_[ê·¸ë¦¼04] ìˆœí™˜ì°¸ì¡° 04 REACHABLE ìƒíƒœ ë³€ê²½_

ìœ„ ì‘ì—…ì´ ëë‚˜ë©´ `link_1` ê°ì²´ë¥¼ ìŠ¤ìº”í•´ì„œ ì´ë¡œë¶€í„° ë„ë‹¬í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê°ì²´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.

ë”°ë¼ì„œ `link_3` ê°ì²´ì˜ ìƒíƒœë¥¼ UNREACHì—ì„œ REACHABLE ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

ì´ ê³¼ì •ì—ì„œ GCëŠ” `PREV_MASK_COLLECTING` flagë¥¼ í†µí•´ ê° ê°ì²´ë¥¼ 1ë²ˆì”©ë§Œ ë°©ë¬¸í•©ë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ `link_4` ê°ì²´ëŠ” ë„ë‹¬í•  ìˆ˜ ì—†ëŠ” ë‹¤ì‹œë§í•´ ìˆœí™˜ì°¸ì¡°í•˜ëŠ” ê°ì²´ì´ë©° ì´ ê°ì²´ì˜ ë©”ëª¨ë¦¬ëŠ” í• ë‹¹ í•´ì œë©ë‹ˆë‹¤.

---
## ë§ˆë¬´ë¦¬í•˜ë©°

ì´ë²ˆ ê¸€ì—ì„œëŠ” íŒŒì´ì¬ì˜ GCë¥¼ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤.

GCëŠ” ë™ì ìœ¼ë¡œ í• ë‹¹ëœ ë©”ëª¨ë¦¬ë¥¼ í•´ì œí•˜ëŠ” ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

íŒŒì´ì¬ GCëŠ” ì°¸ì¡° íšŸìˆ˜ì™€ ìˆœí™˜ì°¸ì¡°ë¥¼ í™•ì¸í•˜ëŠ” ë°©ë²•ì„ í†µí•´ ë™ì  ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•©ë‹ˆë‹¤.

ì´ ê¸€ì´ ì¡°ê¸ˆì´ë‚˜ë§ˆ ë„ì›€ì´ ë˜ì…¨ìœ¼ë©´ í•©ë‹ˆë‹¤.

ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜€

---
## ì°¸ê³  ë¬¸í—Œ

- ì“°ë ˆê¸° ìˆ˜ì§‘ (ì»´í“¨í„° ê³¼í•™), [https://ko.wikipedia.org/wiki/ì“°ë ˆê¸°_ìˆ˜ì§‘_(ì»´í“¨í„°_ê³¼í•™)](https://ko.wikipedia.org/wiki/ì“°ë ˆê¸°_ìˆ˜ì§‘_(ì»´í“¨í„°_ê³¼í•™))
- sys â€” ì‹œìŠ¤í…œ íŠ¹ì • íŒŒë¼ë¯¸í„°ì™€ í•¨ìˆ˜, [https://docs.python.org/ko/3.11/library/sys.html#sys.getrefcount](https://docs.python.org/ko/3.11/library/sys.html#sys.getrefcount)
- Garbage Collector Design, [https://devguide.python.org/internals/garbage-collector/](https://devguide.python.org/internals/garbage-collector/)
- bpo-41323: Perform 'peephole' optimizations directly on the CFG, [https://github.com/python/cpython/pull/21517/commits](https://github.com/python/cpython/pull/21517/commits)
- Why does a newly created variable in Python have a ref-count of four?, [https://stackoverflow.com/questions/45021901/why-does-a-newly-created-variable-in-python-have-a-ref-count-of-four](https://stackoverflow.com/questions/45021901/why-does-a-newly-created-variable-in-python-have-a-ref-count-of-four)
- Garbage collection in Python: things you need to know, [https://rushter.com/blog/python-garbage-collector/](https://rushter.com/blog/python-garbage-collector/)
